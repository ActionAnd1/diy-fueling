<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
\1
<!-- PWA: Manifest & iOS Meta -->
  <link rel="manifest" href="/diy-fueling/manifest.json">
  <meta name="theme-color" content="#326464">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180.png">

<style>
  :root{
    --primary:#326464;
    --primary-700:#234747;
    --bg:#0b0b0c; --card:#ffffff; --text:#0f1115; --muted:#6b7280; --pill:#f3f4f6;
  }
  html,body{margin:0;padding:0;background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;color:var(--text)}
  .wrap{max-width:880px;margin:28px auto;padding:0 18px}
  .card{background:var(--card);border-radius:28px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:28px 26px}
  h1{font-size:36px;margin:0 0 8px} h2{font-size:24px;margin:0 0 14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
  .group{display:flex;flex-direction:column;gap:8px}
  .row{display:flex;gap:10px;align-items:center}
  label{font-weight:600}
  input[type="number"], input[type="text"]{
    width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:14px;font-size:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;background:var(--primary);color:#fff;border:none;border-radius:16px;padding:14px 18px;font-weight:700;font-size:16px;cursor:pointer}
  .btn:hover{background:var(--primary-700)}
  .ghost{background:#eef2f7;color:#111;border:none;border-radius:12px;padding:8px 10px;font-weight:600;cursor:pointer}
  .kicker{color:var(--muted);font-size:14px;margin-top:-4px}
  .radio{display:flex;gap:12px;flex-wrap:wrap}
  .radio label{font-weight:500;padding:8px 12px;border:1px solid #e5e7eb;border-radius:14px;display:flex;gap:8px;align-items:center;cursor:pointer}
  .radio input{accent-color:var(--primary)}
  .pill{background:var(--pill);border-radius:16px;padding:10px 12px;display:flex;flex-direction:column;align-items:center}
  .pill b{font-size:22px}
  .list{margin:14px 0 0;padding:0;list-style:none}
  .list li{display:flex;justify-content:space-between;align-items:center;padding:12px 10px;border-bottom:1px solid #eef2f7}

  /* Slider mit Füllung von links in Theme-Farbe */
  .slider{
    -webkit-appearance:none;appearance:none;width:100%;height:12px;border-radius:8px;background:
      linear-gradient(to right,var(--primary) 0%, var(--primary) var(--fill,0%), #e5e7eb var(--fill,0%), #e5e7eb 100%);
    outline:none;transition:background-size .15s linear;
  }
  .slider::-webkit-slider-thumb{
    -webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:#fff;border:3px solid var(--primary);cursor:pointer}
  .intensity-labels{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-top:6px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .unit{color:var(--muted);font-size:14px}
  @media (max-width:820px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Berechne dein DIY-Getränk</h2>
    <div class="grid">
      <!-- Intensität + KH/h -->
      <div class="group">
        <label>Intensität <span id="intensity-name" class="kicker">(Gering)</span></label>
        <input id="intensity" class="slider" type="range" min="40" max="120" step="1" value="60" />
        <div class="intensity-labels"><span>40</span><span>80</span><span>120</span></div>
        <div class="inline">
          <label for="khph" class="kicker" style="font-weight:600">KH/h</label>
          <input id="khph" type="number" min="40" max="120" step="1" value="60" style="width:110px"/>
          <span class="unit">g/h</span>
          <button class="ghost" id="btn60" type="button">60</button>
          <button class="ghost" id="btn80" type="button">80</button>
          <button class="ghost" id="btn100" type="button">100</button>
        </div>
      </div>

      <!-- Dauer -->
      <div class="group">
        <label>Dauer</label>
        <div class="row">
          <input id="hours" type="number" min="0" value="1" aria-label="Stunden"/>
          <input id="minutes" type="number" min="0" max="59" value="0" aria-label="Minuten"/>
        </div>
      </div>

      <!-- Rezept -->
      <div class="group">
        <label>Rezept</label>
        <div class="radio">
          <label><input type="radio" name="recipe" value="saft" checked/> SaftMix</label>
          <label><input type="radio" name="recipe" value="zucker"/> ZuckerMix</label>
          <label><input type="radio" name="recipe" value="mafru"/> MaFruMix</label>
        </div>
      </div>

      <!-- Form -->
      <div class="group">
        <label>Form</label>
        <div class="radio">
          <label><input type="radio" name="form" value="gel" checked/> Gel</label>
          <label><input type="radio" name="form" value="flasche"/> Flasche</label>
        </div>
      </div>
    </div>

    <div style="margin-top:18px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <button class="btn" id="calc" type="button">Rezept berechnen</button>
      <div class="pill"><span class="kicker">Gesamt-KH</span><b id="kh-total">–</b></div>
      <div class="pill"><span class="kicker">KH pro Stunde</span><b id="kh-ph">–</b></div>
      <div class="pill"><span class="kicker">Glukose : Fruktose</span><b id="ratio">–</b></div>
      <div class="pill"><span class="kicker">Verhältnis</span><b id="ratio-simple">–</b></div>
    </div>
  </div>

  <div class="card" style="margin-top:18px">
    <h1>Rezept</h1>
    <ul class="list" id="ingredients"></ul>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
      <div class="pill"><span class="kicker">Glukose gesamt</span><b id="g-total">–</b></div>
      <div class="pill"><span class="kicker">Fruktose gesamt</span><b id="f-total">–</b></div>
    </div>
    <p class="kicker" id="form-note" style="margin-top:10px"></p>
  </div>
</div>

<script>
/* ===== Helpers & Elements ===== */
const fmt0 = n => Math.round(n).toLocaleString('de-DE');
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

const intensityEl=document.getElementById('intensity');
const khphEl=document.getElementById('khph');
const intensityNameEl=document.getElementById('intensity-name');
const hoursEl=document.getElementById('hours');
const minutesEl=document.getElementById('minutes');
const ingredientsEl=document.getElementById('ingredients');
const khTotalEl=document.getElementById('kh-total');
const khPhEl=document.getElementById('kh-ph');
const ratioEl=document.getElementById('ratio');
const ratioSimpleEl=document.getElementById('ratio-simple');
const gTotalEl=document.getElementById('g-total');
const fTotalEl=document.getElementById('f-total');
const formNoteEl=document.getElementById('form-note');

/* Slider-Füllung aktualisieren */
function updateFill(){
  const min=+intensityEl.min,max=+intensityEl.max,val=+intensityEl.value;
  intensityEl.style.setProperty('--fill',100*(val-min)/(max-min)+'%');
}
function setKH(v){
  const kh=clamp(Math.round(v),+intensityEl.min,+intensityEl.max);
  intensityEl.value=kh; khphEl.value=kh; updateFill();
  let name='Benutzerdefiniert'; if(kh===60) name='Gering'; else if(kh===80) name='Intensiv'; else if(kh===100) name='Rennen';
  intensityNameEl.textContent=`(${name})`;
}
intensityEl.addEventListener('input',e=>setKH(e.target.value));
khphEl.addEventListener('input',e=>setKH(e.target.value));
document.getElementById('btn60').onclick=()=>setKH(60);
document.getElementById('btn80').onclick=()=>setKH(80);
document.getElementById('btn100').onclick=()=>setKH(100);
updateFill();

/* Radiovalue */
function getChecked(name){return document.querySelector(`input[name="${name}"]:checked`).value;}

/* Verteilungslogik (deine Regeln) */
function calcGlucoseFructose(khPerHour,hours){
  const total=khPerHour*hours;
  let g,f;
  if(khPerHour<=90){ // immer 2:1
    g=total*2/3; f=total/3;
  } else if(khPerHour<=108){ // G capped bei 60 g/h, F steigt bis 0,8*G
    g=60*hours;
    f=total-g;
    const fMax=0.8*g;
    if(f>fMax) f=fMax;
  } else { // >108 g/h -> Verhältnis 1:0,8
    g=total/1.8; // da g + 0.8g = 1.8g
    f=0.8*g;
  }
  return [Math.round(g),Math.round(f),Math.round(total)];
}

/* Berechnung */
document.getElementById('calc').addEventListener('click',()=>{
  const hVal=Math.max(0,Number(hoursEl.value||0));
  const mVal=clamp(Math.max(0,Number(minutesEl.value||0)),0,59);
  minutesEl.value=mVal;
  const h=hVal+mVal/60;
  if(h<=0){alert('Bitte Dauer >0 eingeben.');return;}
  const khPerHour=Number(khphEl.value||60);

  let [glucoseTarget,fructoseTarget,totalKH]=calcGlucoseFructose(khPerHour,h);

  const recipe=getChecked('recipe');
  const form=getChecked('form');

  const lemonML=10*h; const saltG=1*h;

  const lines=[]; const add=(n,a,u)=>lines.push({name:n,amount:a,unit:u});
  let saftML=0;

  if(recipe==='zucker'){
    // Sucrose (50/50) + Maltodextrin
    const S=2*fructoseTarget;           // g Saccharose
    const M=Math.max(0,glucoseTarget-0.5*S);
    add('Haushaltszucker',S,'g');
    add('Maltodextrin',M,'g');
    add('Zitronensaft',lemonML,'ml');
    add('Salz',saltG,'g');
  } else if(recipe==='mafru'){
    add('Maltodextrin',glucoseTarget,'g');
    add('Fruktose (Pulver)',fructoseTarget,'g');
    add('Zitronensaft',lemonML,'ml');
    add('Salz',saltG,'g');
  } else { // SaftMix (Traubensaft 50/50 + Agave fruktosebetont + Maltodextrin)
    // einfache, robuste Näherung: decke einen Teil der Fruktose über Agave, Rest via Saft; Glukose-Lücke via Malto
    let SA_F=0.6*fructoseTarget;
    let SA_G=(SA_F/0.90)*0.10;         // G aus Agave
    let SJ_F=Math.max(0,fructoseTarget-SA_F);
    let SJ_G=SJ_F;                     // 50/50 Saft
    let M=glucoseTarget-(SA_G+SJ_G);
    let guard=0; while(M<0 && guard<20){ guard++; SA_F*=0.9; SA_G=(SA_F/0.90)*0.10; SJ_F=Math.max(0,fructoseTarget-SA_F); SJ_G=SJ_F; M=glucoseTarget-(SA_G+SJ_G); }
    if(M<0) M=0;

    const SJ_kh=SJ_F+SJ_G;
    saftML = SJ_kh/0.12;               // 12 g / 100 ml

    const SA_asIs_g=SA_F/0.90;

    add('Traubensaft',saftML,'ml');
    add('Maltodextrin',M,'g');
    add('Agavendicksaft',SA_asIs_g,'g');
    add('Zitronensaft',lemonML,'ml');
    add('Salz',saltG,'g');
  }

  // Wasserregel
  if(form==='gel'){
    const targetWater=(2/3*totalKH)-(lemonML+saftML);
    const water=Math.max(0,Math.round(targetWater));
    if(water>0) add('Wasser',water,'ml');
    formNoteEl.textContent='Form: Gel – Wasser = ⅔·KH – (Zitrone + Saft), gerundet.';
  } else {
    const water=500*h;
    add('Wasser (Richtwert)',water,'ml');
    formNoteEl.textContent='Form: Flasche – Richtwert ~500–750 ml pro Stunde.';
  }

  // Ausgabe
  ingredientsEl.innerHTML='';
  lines.forEach(x=>{
    const li=document.createElement('li');
    li.innerHTML=`<div>${x.name}</div><div><b>${fmt0(x.amount)}</b> ${x.unit}</div>`;
    ingredientsEl.appendChild(li);
  });

  khTotalEl.textContent=`${fmt0(totalKH)} g`;
  khPhEl.textContent=`${fmt0(khPerHour)} g/h`;
  ratioEl.textContent=`${fmt0(glucoseTarget)} : ${fmt0(fructoseTarget)}`;

  // Verhältnis-Kachel: bis 90 -> 2:1, sonst 1:x (x = F/G)
  let ratioSimple;
  if(khPerHour<=90){
    ratioSimple='2 : 1';
  }else{
    ratioSimple = `1 : ${(fructoseTarget/Math.max(1,glucoseTarget)).toFixed(2)}`;
  }
  ratioSimpleEl.textContent = ratioSimple;

  gTotalEl.textContent=`${fmt0(glucoseTarget)} g`;
  fTotalEl.textContent=`${fmt0(fructoseTarget)} g`;
});
</script>

<!-- PWA: Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/diy-fueling/sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
